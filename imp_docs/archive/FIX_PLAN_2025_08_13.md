# Fix Plan for nano-Grazynka Issues

**Created**: August 13, 2025  
**Status**: ACTIVE  
**Purpose**: Address all issues identified in TEST_RESULTS_2025_08_13.md  
**Test Pass Rate**: Current 79.8% â†’ Target 95%+

## Executive Summary

This plan addresses 14 failed tests and 4 blocked tests identified during comprehensive testing on August 13, 2025. The most critical issue is the broken anonymous session authentication preventing anonymous users from uploading files.

## Issues by Priority

### ðŸ”´ Priority 1 - Critical (Must Fix Immediately)

#### 1. Anonymous Session Authentication Broken
**Problem**: Frontend doesn't send `x-session-id` headers with API requests, causing 401 errors for anonymous users.

**Impact**: 
- Anonymous users cannot upload files at all
- Blocks the entire anonymous user flow
- Affects tests: A2.6, A2.7, A2.8

**Root Cause**:
- `frontend/lib/api.ts` - uploadVoiceNote() doesn't add x-session-id header
- `frontend/app/page.tsx` - Headers are prepared but not included in fetch call

**Files to modify**:
```
frontend/lib/api.ts - Line 99-104 (uploadVoiceNote function)
frontend/app/page.tsx - Lines 226-239 (upload fetch call)
```

**Fix Implementation**:
```typescript
// frontend/lib/api.ts
const headers: HeadersInit = {};
if (sessionId) {
  headers['x-session-id'] = sessionId;
}

const response = await fetch('http://localhost:3101/api/voice-notes', {
  method: 'POST',
  credentials: 'include',
  headers,  // ADD THIS
  body: formData
});
```

### ðŸŸ¡ Priority 2 - Major Issues (Should Fix)

#### 2. Model Selection Persistence
**Problem**: Selected transcription model resets when collapsing/expanding Advanced Options.

**Impact**:
- Poor user experience
- Users lose their model selection
- Affects test: M7.11

**Root Cause**:
- State management issue in AdvancedOptions component
- Model state might be getting reset on toggle

**Files to modify**:
```
frontend/app/page.tsx - Lines 97-99 (state management)
frontend/components/AdvancedOptions.tsx - Props handling
```

**Fix Implementation**:
- Ensure selectedModel state persists at parent level
- Consider using localStorage for persistence across sessions
- Add useEffect to save/restore model selection

#### 3. Logout Session Cleanup
**Problem**: Logout doesn't properly clear all session data.

**Impact**:
- Security concern - session data persists
- localStorage items not cleared
- Affects tests: F3.15

**Root Cause**:
- `AuthContext.tsx` logout() doesn't clear localStorage
- Only clears cookie, not local session data

**Files to modify**:
```
frontend/contexts/AuthContext.tsx - Lines 118-130 (logout function)
```

**Fix Implementation**:
```typescript
const logout = async () => {
  try {
    await fetch(`${API_URL}/api/auth/logout`, {
      method: 'POST',
      credentials: 'include',
    });
  } catch (error) {
    console.error('Logout error:', error);
  } finally {
    setUser(null);
    Cookies.remove('token');
    // ADD: Clear all localStorage items
    clearAnonymousSession();
    localStorage.clear();
    // Reset anonymous session
    const newSessionId = getOrCreateSessionId();
    setAnonymousSessionId(newSessionId);
    setAnonymousUsageCount(0);
  }
};
```

### ðŸŸ¢ Priority 3 - Minor Issues (Nice to Fix)

#### 4. Registration Form Validation
**Problem**: Registration form lacks proper validation.

**Impact**:
- Users can submit invalid data
- Poor error feedback
- Affects test: F3.14

**Files to modify**:
```
frontend/app/(auth)/register/page.tsx
```

**Fix Implementation**:
- Add email regex validation
- Add password strength requirements (min 8 chars, 1 number, 1 special)
- Display validation errors inline
- Disable submit until valid

#### 5. Anonymous Limit Modal
**Problem**: ConversionModal doesn't trigger after 5 free uses.

**Impact**:
- Users don't see upgrade prompt
- Confusing when limit reached
- Affects test: F3.16

**Files to modify**:
```
frontend/app/page.tsx - Lines 114-124 (usage limit check)
```

**Fix Implementation**:
- Check usage before allowing upload
- Show ConversionModal when limit reached
- Block upload button when at limit

#### 6. Error Recovery Mechanism
**Problem**: No retry logic for network failures.

**Impact**:
- Single network hiccup fails entire upload
- Poor user experience
- Affects tests: I4.5, E6.6

**Files to modify**:
```
frontend/lib/api.ts - Add retry utility
frontend/app/page.tsx - Use retry logic in upload
```

**Fix Implementation**:
```typescript
// Add retry utility
async function retryWithBackoff(
  fn: () => Promise<any>,
  maxRetries = 3,
  delay = 1000
) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (error) {
      if (i === maxRetries - 1) throw error;
      await new Promise(r => setTimeout(r, delay * Math.pow(2, i)));
    }
  }
}
```

## Implementation Plan

### Phase 1: Critical Fix (Day 1 - Immediate)
1. âœ… Fix anonymous session authentication
2. âœ… Test with curl to verify headers working
3. âœ… Test anonymous upload flow E2E

### Phase 2: Major Fixes (Day 1 - After Critical)
1. âœ… Fix model selection persistence
2. âœ… Fix logout session cleanup
3. âœ… Test auth flows and model selection

### Phase 3: Minor Fixes (Day 2)
1. âœ… Add registration validation
2. âœ… Fix anonymous limit modal
3. âœ… Add retry logic
4. âœ… Run full test suite

## Testing Checklist

### Manual Testing
- [ ] Anonymous user can upload file
- [ ] Model selection persists on collapse/expand
- [ ] Logout clears all session data
- [ ] Registration validates email/password
- [ ] Anonymous limit modal shows at 5 uses
- [ ] Network retry works on failure

### Automated Testing
- [ ] Run test-anonymous-upload.js
- [ ] Run Playwright E2E tests
- [ ] Run full test suite
- [ ] Verify all P1 tests pass
- [ ] Verify all P2 tests pass

## Success Metrics

### Before Fixes
- Test Pass Rate: 79.8% (71/89)
- Failed Tests: 14
- Blocked Tests: 4

### After Fixes (Target)
- Test Pass Rate: >95%
- Failed Tests: <5
- Blocked Tests: 0
- All P1 issues resolved
- All P2 issues resolved

## Code Examples

### Complete Fix for Anonymous Auth

```typescript
// frontend/lib/api.ts
export async function uploadVoiceNote(
  file: File,
  language?: string,
  whisperPrompt?: string,
  sessionId?: string,
  transcriptionModel?: string,
  geminiSystemPrompt?: string,
  geminiUserPrompt?: string
): Promise<{ success: boolean; data?: { id: string }; error?: string }> {
  try {
    const formData = new FormData();
    formData.append('file', file);
    
    // ... append other fields ...
    
    // CRITICAL: Add headers for anonymous session
    const headers: HeadersInit = {};
    if (sessionId) {
      headers['x-session-id'] = sessionId;
    }
    
    const response = await fetch('http://localhost:3101/api/voice-notes', {
      method: 'POST',
      credentials: 'include',
      headers,  // THIS WAS MISSING!
      body: formData
    });
    
    // ... rest of function
  }
}
```

## Rollback Plan

If any fix causes regression:
1. Revert the specific commit
2. Re-test previous functionality
3. Document the issue
4. Try alternative approach

## Dependencies

- No external dependencies required
- All fixes are frontend-only
- Backend already supports x-session-id headers

## Risk Assessment

### Low Risk
- Adding headers (well-understood)
- Session cleanup (straightforward)
- Validation (isolated change)

### Medium Risk
- Model persistence (state management)
- Retry logic (timing issues)

### Mitigation
- Test each fix in isolation
- Deploy incrementally
- Monitor error rates

## Timeline

**Day 1 (Immediate)**:
- Morning: Fix P1 anonymous auth (1 hour)
- Afternoon: Fix P2 issues (2 hours)
- Testing: Verify critical flows (1 hour)

**Day 2**:
- Morning: Fix P3 issues (2 hours)
- Afternoon: Full test suite (2 hours)
- Sign-off: Review and deploy

## Approval

- [ ] Plan reviewed
- [ ] Priorities agreed
- [ ] Timeline approved
- [ ] Ready to implement

---

**Status**: Ready for implementation  
**Next Step**: Fix anonymous session authentication immediately