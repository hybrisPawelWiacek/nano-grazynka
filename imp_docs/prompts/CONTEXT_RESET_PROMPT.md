# Context Reset Prompt - Fix Implementation

## Use this prompt after context reset to execute the fix plan:

---

I need you to implement the fixes documented in `imp_docs/planning/FIX_PLAN_2025_08_13.md`. This plan addresses test failures from `imp_docs/testing/TEST_RESULTS_2025_08_13.md`.

## Critical Context:
- We completed multi-model transcription feature (GPT-4o vs Gemini 2.0 Flash)
- Test execution showed 79.8% pass rate with 14 failed tests
- Most critical issue: Anonymous users can't upload files due to missing x-session-id headers

## Priority 1 - Fix Anonymous Authentication (CRITICAL):

1. **Fix frontend/lib/api.ts** (line ~99-104):
   - In `uploadVoiceNote()` function, the headers object is created but NOT passed to fetch
   - Add `headers` to the fetch options when sessionId exists
   - Current code has `headers` variable but fetch() doesn't use it

2. **Fix frontend/app/page.tsx** (line ~226-239):
   - In `handleUpload()`, uploadHeaders is prepared with x-session-id
   - But the fetch call to upload endpoint doesn't include headers property
   - Add `headers: uploadHeaders` to the fetch options

## Priority 2 - Fix These Issues:

3. **Model Selection Persistence**:
   - Problem: Selected model resets when collapsing Advanced Options
   - Fix: Ensure selectedModel state persists in parent component

4. **Logout Session Cleanup**:
   - Problem: Logout doesn't clear localStorage
   - Fix: In `frontend/contexts/AuthContext.tsx` logout(), add `clearAnonymousSession()` and `localStorage.clear()`

## Priority 3 - Minor Fixes:

5. Registration validation in `frontend/app/(auth)/register/page.tsx`
6. Anonymous limit modal trigger in `frontend/app/page.tsx`
7. Add retry logic with exponential backoff

## Testing After Each Fix:

For anonymous auth fix, test with:
```bash
# Test anonymous upload with curl
curl -X POST http://localhost:3101/api/voice-notes \
  -H "x-session-id: test-session-123" \
  -F "file=@tests/test-data/zabka.m4a"
```

## Important Notes:
- Backend ALREADY supports x-session-id headers (verified in backend/src/presentation/api/routes/voiceNotes.ts line 67)
- All fixes are frontend-only
- The sessionId is generated by `getOrCreateSessionId()` from `frontend/lib/anonymousSession.ts`
- Memory entities have full investigation details: FIX_PLAN_INVESTIGATION_2025_08_13, ANONYMOUS_AUTH_BUG_DETAILS

## Implementation Order:
1. Fix anonymous auth first (blocks all anonymous users)
2. Test the fix works
3. Fix model persistence and logout
4. Fix remaining P3 issues
5. Run full test suite to verify

Start by reading the fix plan and implementing the P1 critical fix for anonymous authentication.

---

## Additional Context If Needed:

The fix plan has detailed code examples. The main issue is that in two places, we prepare headers with x-session-id but don't actually include them in the fetch() call. It's a simple omission - the code to prepare headers exists, it just needs to be used.

Backend expects the header 'x-session-id' (lowercase x, hyphenated). The frontend has the sessionId from localStorage, prepares the header, but forgets to include it in the fetch options.